<!DOCTYPE html>
<!--suppress JSUnresolvedLibraryURL -->
<html>
<head>
	<title>Static</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="webjars/bootstrap/3.3.7/css/bootstrap.min.css"/>
	<link rel="stylesheet" href="styles.css"/>
</head>
<body>

<script src="https://checkout.stripe.com/checkout.js"></script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>

<div class="container">
	<div id="alertTop" class="alert-top" role="alert"></div>
	<div class="donation-selection">
		<p>Donate:</p>
		<button id="donateButton_5" class="btn btn-primary express-button">$5</button>
		<button id="donateButton_10" class="btn btn-primary express-button">$10</button>
		<button id="donateButton_25" class="btn btn-primary express-button">$25</button>
		<button id="donateButton_50" class="btn btn-primary express-button">$50</button>
		<button id="donateButton_100" class="btn btn-primary express-button">$100</button>
		<br/>
		<br/>
		<p>Or, donate a specific amount:</p>
		<form>
			<fieldset class="form-group">
				<div class="input-group">
					<span class="input-group-addon">$</span>
					<input type="number" class="form-control" id="donationAmount" name="amount" placeholder="Enter amount" style="width:150px">
					<button id="donateButton_custom" class="btn btn-primary" style="margin-left: -2px;">Donate</button>
				</div>
			</fieldset>
		</form>
	</div>

	<div class="multi-pay-options">
		<h3 align="center">Choose payment method</h3>
		<h4 align="center">(Apple Pay or Credit Card)</h4>
		<br/>
		<button id="apple-pay-button" class="apple-pay-button"></button>
		<br/>
		<button id="credit-pay-button" type="button" class="credit-pay-button btn btn-default" aria-label="Center Align">
			<span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span>
			Credit Card
		</button>
		<br/>
		<button id="cancel-button" type="button" class="credit-pay-button btn btn-default" aria-label="Center Align">
			<!--<span class="glyphicon" aria-hidden="true"></span>-->
			Cancel
		</button>
		<br/>
		<br/>
		<div id="donationAmountAlert" class="alert alert-info" role="alert"></div>
	</div>

</div>

<script type="text/javascript" src="webjars/jquery/2.0.3/jquery.min.js"></script>

<script>
	"use strict";

	function init(publishableKey) {
		var submittedAmount = 0;
		var submittedAmountStr = "";
		var applePayEnabled = false;
		var organizationDisplayName = "Jessica Vaughn"; // TODO Make this a parameter

		function doSuccess(amount, email) {
			var loc = "successfulPayment?amount=" + amount;
			if (email) {
				loc += "&email=" + email;
			}
			window.location = loc;
		}

		var handler = StripeCheckout.configure({
			key: publishableKey,
			image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
			locale: 'auto',
			currency: 'usd',
			token: function(token) {
				// You can access the token ID with `token.id`.
				// Get the token ID to your server-side code for use.
				var param = {
					id: token.id,
					currency: 'usd',
					amount: submittedAmount,
					description: token.email,
					token: token
				};
				// console.log(param);
				$.ajax({
					type: 'POST',
					url: 'submitPayment',
					data: JSON.stringify(param),
					contentType: "application/json",
					dataType: 'json',
					success: function(data) {
						console.log(data);
						doSuccess(data.amount, data.email);
					}
				});
			}
		});

		function beginApplePay() {
			var paymentRequest = {
				countryCode: 'US',
				currencyCode: 'USD',
				total: {
					label: organizationDisplayName,
					amount: submittedAmountStr
				}
			};
			var session = Stripe.applePay.buildSession(paymentRequest,
				function(result, completion) {

					$.post('submitPayment', {token: result.token.id}).done(function() {
						completion(ApplePaySession.STATUS_SUCCESS);
						// You can now redirect the user to a receipt page, etc.
						doSuccess(submittedAmount, null);
					}).fail(function() {
						completion(ApplePaySession.STATUS_FAILURE);
					});

				}, function(error) {
					console.log(error.message);
				});

			session.begin();
		}

		function doCreditCardDonate() {
			handler.open({
				name: organizationDisplayName,
				description: 'Donate $' + submittedAmountStr,
				amount: submittedAmount
			});
		}

		function handleDonate(amount, amountStr) {
			// Open Checkout with further options:
			submittedAmount = amount;
			submittedAmountStr = amountStr;
			if (!applePayEnabled) {
				doCreditCardDonate();
			} else {
				$('#donationAmountAlert').text("Amount: $" + submittedAmountStr);
				$('.donation-selection').hide();
				$('.multi-pay-options').show();
			}
		}

		$('#cancel-button').click(function() {
			$('.donation-selection').show();
			$('.multi-pay-options').hide();
		});

		$('#credit-pay-button').click(doCreditCardDonate);

		$('#apple-pay-button').click(beginApplePay);

		document.getElementById('donateButton_custom').addEventListener('click', function(e) {
			var amount = document.getElementById("donationAmount").value;
			if (amount) {
				handleDonate(parseInt(amount) * 100, amount);
			}
			e.preventDefault();
		});

		document.getElementById('donateButton_5').addEventListener('click', function(e) {
			handleDonate(500, "5");
			e.preventDefault();
		});

		document.getElementById('donateButton_10').addEventListener('click', function(e) {
			handleDonate(1000, "10");
			e.preventDefault();
		});

		document.getElementById('donateButton_25').addEventListener('click', function(e) {
			handleDonate(2500, "25");
			e.preventDefault();
		});

		document.getElementById('donateButton_50').addEventListener('click', function(e) {
			handleDonate(5000, "50");
			e.preventDefault();
		});

		document.getElementById('donateButton_100').addEventListener('click', function(e) {
			handleDonate(10000, "100");
			e.preventDefault();
		});

		// Close Checkout on page navigation:
		window.addEventListener('popstate', function() {
			handler.close();
		});

		// Apple Pay
		Stripe.applePay.checkAvailability(function(available) {
			if (available) {
				applePayEnabled = true;
				console.log("Apple Pay enabled");
				//document.getElementById('apple-pay-button').style.display = 'block';
			} else {
				console.log("Apple Pay not available");
			}
		});
	}
	$(document).ready(function() {
		$.ajax({
			type: 'GET',
			url: 'getPublishableKey',
			contentType: "application/json",
			dataType: 'json',
			success: function(data) {
				//console.log(data);
				if (data.startsWith("pk_test")) {
					console.log("TEST MODE - No money will be transferred");
					$('#alertTop').addClass('alert').addClass('alert-danger').text('! TEST MODE - No money will be transferred !');
				}
				init(data);
			},
			error: function(x, textStatus, errorThrown) {
				console.log("textStatus: " + textStatus);
				console.log("errorThrown: " + errorThrown);
			}
		});
	});

</script>

<script type="text/javascript" src="webjars/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</body>
</html>